<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Advocacia</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f0f;
      --surface: #161616;
      --surface2: #1e1e1e;
      --surface3: #252525;
      --border: #2a2a2a;
      --gold: #c9a84c;
      --gold-light: #e8c97a;
      --gold-dim: rgba(201, 168, 76, 0.15);
      --text: #e8e8e8;
      --text-dim: #888;
      --text-muted: #555;
      --green: #4caf7d;
      --red: #e05c5c;
      --blue: #5c8de0;
      --radius: 8px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    /* TEMA LIGHT */
    body.light {
      --bg: #f4f1eb;
      --surface: #ffffff;
      --surface2: #f0ece2;
      --surface3: #e8e3d8;
      --border: #ddd8cc;
      --gold: #a67c2e;
      --gold-light: #c9a84c;
      --gold-dim: rgba(166, 124, 46, 0.1);
      --text: #1a1a1a;
      --text-dim: #555;
      --text-muted: #999;
      --green: #2e7d52;
      --red: #c0392b;
      --blue: #2c5f9e;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
    }

    /* BOTAO TEMA */
    .theme-toggle {
      width: 40px;
      height: 22px;
      border-radius: 11px;
      background: var(--border);
      border: none;
      cursor: pointer;
      position: relative;
      transition: background 0.3s;
      flex-shrink: 0;
      outline: none;
    }

    .theme-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--gold);
      transition: transform 0.3s;
    }

    body.light .theme-toggle::after {
      transform: translateX(18px);
    }

    body.light .theme-toggle {
      background: var(--gold-dim);
    }

    .theme-icon {
      font-size: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      min-height: 100vh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
    }

    .sidebar-logo {
      padding: 28px 24px 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-logo h1 {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--gold);
      letter-spacing: 0.5px;
    }

    .sidebar-logo span {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .nav {
      flex: 1;
      padding: 16px 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 24px;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      position: relative;
    }

    .nav-item:hover {
      color: var(--text);
      background: var(--surface2);
    }

    .nav-item.active {
      color: var(--gold);
      border-left-color: var(--gold);
      background: var(--gold-dim);
    }

    .nav-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
    }

    .sidebar-footer span {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* MAIN */
    .main {
      margin-left: 240px;
      flex: 1;
      min-height: 100vh;
    }

    .topbar {
      height: 60px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .topbar-title {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      color: var(--text);
    }

    .topbar-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* CONTENT */
    .page {
      display: none;
      padding: 32px;
    }

    .page.active {
      display: block;
    }

    /* CARDS DASHBOARD */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 3px;
      height: 100%;
      background: var(--gold);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-family: 'Playfair Display', serif;
      font-size: 36px;
      color: var(--gold);
    }

    .stat-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* TABLE */
    .table-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .table-header h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      padding: 12px 20px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    tbody tr:hover {
      background: var(--surface2);
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    td {
      padding: 14px 20px;
      font-size: 14px;
    }

    /* BADGE */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .badge-green {
      background: rgba(76, 175, 125, 0.15);
      color: var(--green);
    }

    .badge-red {
      background: rgba(224, 92, 92, 0.15);
      color: var(--red);
    }

    .badge-gold {
      background: var(--gold-dim);
      color: var(--gold);
    }

    .badge-blue {
      background: rgba(92, 141, 224, 0.15);
      color: var(--blue);
    }

    .badge-gray {
      background: rgba(136, 136, 136, 0.15);
      color: var(--text-dim);
    }

    /* BUTTONS */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: var(--radius);
      border: none;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-gold {
      background: var(--gold);
      color: #0f0f0f;
    }

    .btn-gold:hover {
      background: var(--gold-light);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-dim);
      border: 1px solid var(--border);
    }

    .btn-outline:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .btn-danger {
      background: rgba(224, 92, 92, 0.15);
      color: var(--red);
      border: 1px solid rgba(224, 92, 92, 0.3);
    }

    .btn-danger:hover {
      background: rgba(224, 92, 92, 0.25);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    .btn-icon {
      padding: 7px;
      border-radius: 6px;
    }

    /* FORMS */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      outline: none;
      transition: border 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--gold);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-select option {
      background: var(--surface2);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      animation: slideUp 0.2s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 24px 28px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
    }

    .modal-body {
      padding: 24px 28px;
    }

    .modal-footer {
      padding: 16px 28px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* SEARCH */
    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 14px;
      min-width: 260px;
    }

    .search-box input {
      background: none;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      width: 100%;
    }

    .search-box svg {
      color: var(--text-muted);
      flex-shrink: 0;
    }

    /* DETAIL PANEL */
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .detail-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
    }

    .detail-card h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }

    .detail-field {
      margin-bottom: 14px;
    }

    .detail-field label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }

    .detail-field span {
      font-size: 14px;
      color: var(--text);
    }

    /* CHAT */
    .chat-box {
      background: var(--surface2);
      border-radius: var(--radius);
      height: 360px;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.5;
    }

    .msg-bot {
      background: var(--surface3);
      color: var(--text);
      align-self: flex-start;
      border-radius: 4px 10px 10px 10px;
    }

    .msg-cliente {
      background: var(--gold-dim);
      color: var(--gold-light);
      align-self: flex-end;
      border-radius: 10px 4px 10px 10px;
    }

    .msg-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    /* STATUS dot */
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .dot-green {
      background: var(--green);
    }

    .dot-red {
      background: var(--red);
    }

    .dot-gray {
      background: var(--text-muted);
    }

    /* TOAST */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 18px;
      font-size: 13px;
      color: var(--text);
      box-shadow: var(--shadow);
      animation: fadeIn 0.2s ease;
      min-width: 220px;
    }

    .toast.success {
      border-left: 3px solid var(--green);
    }

    .toast.error {
      border-left: 3px solid var(--red);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* UPLOAD AREA */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: border 0.2s;
    }

    .upload-area:hover {
      border-color: var(--gold);
    }

    .upload-area p {
      color: var(--text-muted);
      font-size: 13px;
    }

    /* EMPTY STATE */
    .empty {
      text-align: center;
      padding: 48px;
      color: var(--text-muted);
    }

    .empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    .empty p {
      font-size: 14px;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h1>Lex CRM</h1>
      <span>Advocacia Previdenci√°ria</span>
    </div>
    <nav class="nav">
      <div class="nav-item active" onclick="showPage('dashboard')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        Dashboard
      </div>
      <div class="nav-item" onclick="showPage('contatos')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        Contatos
      </div>
      <div class="nav-item" onclick="showPage('agendamentos')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        Agendamentos
      </div>
      <div class="nav-item" onclick="showPage('usuarios')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        Usu√°rios
      </div>
      <div class="nav-item" onclick="showPage('instancias')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
        </svg>
        WhatsApp
      </div>
    </nav>
    <div class="sidebar-footer">
      <span>v1.0 ‚Äî Lex CRM</span>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <span class="topbar-title" id="topbar-title">Dashboard</span>
      <div style="display:flex;align-items:center;gap:12px">
        <span class="theme-icon" id="theme-icon">üåô</span>
        <button class="theme-toggle" onclick="alternarTema()" title="Alternar dark/light"></button>
        <div class="topbar-actions" id="topbar-actions"></div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Contatos</div>
          <div class="stat-value" id="stat-contatos">‚Äî</div>
          <div class="stat-sub">Total cadastrado</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Agendamentos</div>
          <div class="stat-value" id="stat-agendamentos">‚Äî</div>
          <div class="stat-sub">Pendentes</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Usu√°rios</div>
          <div class="stat-value" id="stat-usuarios">‚Äî</div>
          <div class="stat-sub">Ativos</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">WhatsApp</div>
          <div class="stat-value" id="stat-instancias">‚Äî</div>
          <div class="stat-sub">Inst√¢ncias</div>
        </div>
      </div>
      <div class="table-container">
        <div class="table-header">
          <h3>Atividade Recente</h3>
        </div>
        <table>
          <thead>
            <tr>
              <th>Contato</th>
              <th>Telefone</th>
              <th>√öltimo Contato</th>
            </tr>
          </thead>
          <tbody id="tbody-recentes">
            <tr>
              <td colspan="3" class="empty">
                <p>Nenhuma atividade registrada</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- CONTATOS -->
    <div class="page" id="page-contatos">
      <div class="table-container">
        <div class="table-header">
          <h3>Contatos</h3>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="search-box">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input type="text" id="search-contatos" placeholder="Buscar por nome, telefone ou CPF..."
                oninput="buscarContatos()">
            </div>
            <button class="btn btn-gold" onclick="abrirModalContato()">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Novo Contato
            </button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>Telefone</th>
              <th>CPF</th>
              <th>Cadastro</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody-contatos"></tbody>
        </table>
      </div>
    </div>

    <!-- DETALHE CONTATO -->
    <div class="page" id="page-contato-detalhe">
      <div id="detalhe-content"></div>
    </div>

    <!-- AGENDAMENTOS -->
    <div class="page" id="page-agendamentos">
      <div class="table-container">
        <div class="table-header">
          <h3>Agendamentos</h3>
          <button class="btn btn-gold" onclick="abrirModalAgendamento()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Novo Agendamento
          </button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Telefone</th>
              <th>Data</th>
              <th>Hora</th>
              <th>Tipo</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody-agendamentos"></tbody>
        </table>
      </div>
    </div>

    <!-- USU√ÅRIOS -->
    <div class="page" id="page-usuarios">
      <div class="table-container">
        <div class="table-header">
          <h3>Usu√°rios</h3>
          <button class="btn btn-gold" onclick="abrirModalUsuario()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Novo Usu√°rio
          </button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>Email</th>
              <th>Perfil</th>
              <th>Telefone</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody-usuarios"></tbody>
        </table>
      </div>
    </div>

    <!-- INST√ÇNCIAS WHATSAPP -->
    <div class="page" id="page-instancias">
      <div class="table-container">
        <div class="table-header">
          <h3>Inst√¢ncias WhatsApp</h3>
          <button class="btn btn-gold" onclick="abrirModalInstancia()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Conectar WhatsApp
          </button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>URL Evolution</th>
              <th>Inst√¢ncia</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody-instancias"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- MODALS -->

  <!-- Modal Contato -->
  <div class="modal-overlay" id="modal-contato">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-contato-title">Novo Contato</h3>
        <button class="btn btn-outline btn-icon" onclick="fecharModal('modal-contato')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Nome</label>
            <input type="text" class="form-input" id="contato-nome" placeholder="Nome completo">
          </div>
          <div class="form-group">
            <label class="form-label">Telefone *</label>
            <input type="text" class="form-input" id="contato-telefone" placeholder="5585999999999">
          </div>
          <div class="form-group">
            <label class="form-label">CPF</label>
            <input type="text" class="form-input" id="contato-cpf" placeholder="000.000.000-00">
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="contato-email" placeholder="email@exemplo.com">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Observa√ß√µes</label>
          <textarea class="form-textarea" id="contato-obs" placeholder="Notas sobre o contato..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-contato')">Cancelar</button>
        <button class="btn btn-gold" onclick="salvarContato()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Usu√°rio -->
  <div class="modal-overlay" id="modal-usuario">
    <div class="modal">
      <div class="modal-header">
        <h3>Novo Usu√°rio</h3>
        <button class="btn btn-outline btn-icon" onclick="fecharModal('modal-usuario')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Nome *</label>
            <input type="text" class="form-input" id="usuario-nome">
          </div>
          <div class="form-group">
            <label class="form-label">Email *</label>
            <input type="email" class="form-input" id="usuario-email">
          </div>
          <div class="form-group">
            <label class="form-label">Senha *</label>
            <input type="password" class="form-input" id="usuario-senha">
          </div>
          <div class="form-group">
            <label class="form-label">Telefone</label>
            <input type="text" class="form-input" id="usuario-telefone">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Perfil</label>
          <select class="form-select" id="usuario-perfil">
            <option value="advogado">Advogado</option>
            <option value="atendente" selected>Atendente</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-usuario')">Cancelar</button>
        <button class="btn btn-gold" onclick="salvarUsuario()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Inst√¢ncia -->
  <div class="modal-overlay" id="modal-instancia">
    <div class="modal">
      <div class="modal-header">
        <h3>Conectar WhatsApp</h3>
        <button class="btn btn-outline btn-icon" onclick="fecharModal('modal-instancia')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nome da Conex√£o</label>
          <input type="text" class="form-input" id="inst-nome" placeholder="Ex: Principal">
        </div>
        <div class="form-group">
          <label class="form-label">URL da Evolution API</label>
          <input type="text" class="form-input" id="inst-url" placeholder="https://sua-evolution.com">
        </div>
        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="text" class="form-input" id="inst-key" placeholder="Sua chave de API">
        </div>
        <div class="form-group">
          <label class="form-label">Nome da Inst√¢ncia</label>
          <input type="text" class="form-input" id="inst-instance" placeholder="Ex: advocacia">
        </div>

        <!-- Separador IA -->
        <div style="margin:20px 0 16px; border-top:1px solid var(--border); padding-top:16px;">
          <p
            style="font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:14px;">
            ü§ñ Configura√ß√£o de Intelig√™ncia Artificial</p>

          <div class="form-group">
            <label class="form-label">Provedor de IA</label>
            <select class="form-input" id="inst-ia-provedor" onchange="alternarCamposIA()">
              <option value="">Selecione o provedor...</option>
              <option value="gemini">Google Gemini</option>
              <option value="openai">OpenAI (ChatGPT)</option>
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="deepseek">DeepSeek</option>
            </select>
          </div>

          <div class="form-group" id="campo-ia-modelo" style="display:none">
            <label class="form-label">Modelo</label>
            <select class="form-input" id="inst-ia-modelo">
            </select>
          </div>

          <div class="form-group" id="campo-ia-key" style="display:none">
            <label class="form-label">Chave de API da IA</label>
            <input type="password" class="form-input" id="inst-ia-key"
              placeholder="Cole aqui a chave de API do provedor escolhido">
            <span style="font-size:11px; color:var(--text-muted); margin-top:4px; display:block;">A chave fica
              armazenada com seguran√ßa e n√£o √© exibida ap√≥s salvar.</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-instancia')">Cancelar</button>
        <button class="btn btn-gold" onclick="salvarInstancia()">Conectar</button>
      </div>
    </div>
  </div>

  <!-- Modal Agendamento -->
  <div class="modal-overlay" id="modal-agendamento">
    <div class="modal" style="max-width:580px;width:95%">
      <div class="modal-header">
        <h3>Novo Agendamento</h3>
        <button class="btn btn-outline btn-icon" onclick="fecharModal('modal-agendamento')">‚úï</button>
      </div>
      <div class="modal-body">
        <!-- Contato -->
        <div class="form-group">
          <label class="form-label">Contato *</label>
          <select class="form-select" id="ag-contato">
            <option value="">Selecione um contato...</option>
          </select>
        </div>

        <!-- Calend√°rio visual -->
        <div class="form-group">
          <label class="form-label">Data *</label>
          <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden">
            <!-- Header do calend√°rio -->
            <div
              style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border)">
              <button type="button" onclick="mudarSemana(-1)"
                style="background:none;border:none;cursor:pointer;color:var(--text);font-size:18px;padding:4px 8px">‚Äπ</button>
              <span id="cal-titulo" style="font-weight:600;font-size:14px;color:var(--text)">Carregando...</span>
              <button type="button" onclick="mudarSemana(1)"
                style="background:none;border:none;cursor:pointer;color:var(--text);font-size:18px;padding:4px 8px">‚Ä∫</button>
            </div>
            <!-- Dias da semana -->
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;padding:12px" id="cal-dias">
              <div style="text-align:center;color:var(--text-muted);font-size:12px">Carregando...</div>
            </div>
          </div>
          <input type="hidden" id="ag-data">
        </div>

        <!-- Hor√°rios dispon√≠veis -->
        <div class="form-group" id="ag-horarios-group" style="display:none">
          <label class="form-label">Hor√°rio dispon√≠vel *</label>
          <div id="ag-horarios-grid" style="display:flex;flex-wrap:wrap;gap:8px">
            <span style="color:var(--text-muted);font-size:13px">Selecione uma data primeiro</span>
          </div>
          <input type="hidden" id="ag-hora">
        </div>

        <!-- Tipo e Obs -->
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Tipo</label>
            <select class="form-select" id="ag-tipo">
              <option value="primeira_consulta">Primeira Consulta</option>
              <option value="retorno">Retorno</option>
              <option value="urgente">Urgente</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Observa√ß√µes</label>
          <textarea class="form-textarea" id="ag-obs" placeholder="Detalhes do agendamento..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('modal-agendamento')">Cancelar</button>
        <button class="btn btn-gold" onclick="salvarAgendamento()">Salvar Agendamento</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toast-container"></div>

  <script>
    const API = window.location.hostname === 'localhost'
      ? 'http://localhost:8001/api'
      : '/api';

    // ‚îÄ‚îÄ‚îÄ NAVEGA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const titles = {
      dashboard: 'Dashboard', contatos: 'Contatos', agendamentos: 'Agendamentos',
      usuarios: 'Usu√°rios', instancias: 'WhatsApp', 'contato-detalhe': 'Detalhes do Contato'
    };

    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('page-' + page).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => {
        if (n.textContent.toLowerCase().includes(page.split('-')[0])) n.classList.add('active');
      });
      document.getElementById('topbar-title').textContent = titles[page] || page;
      const actions = document.getElementById('topbar-actions');
      actions.innerHTML = '';
      if (page === 'contato-detalhe') {
        actions.innerHTML = `<button class="btn btn-outline" onclick="showPage('contatos')">‚Üê Voltar</button>`;
      }
      const loaders = {
        dashboard: carregarDashboard,
        contatos: carregarContatos,
        agendamentos: carregarAgendamentos,
        usuarios: carregarUsuarios,
        instancias: carregarInstancias,
      };
      if (loaders[page]) loaders[page]();
    }

    // ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toast(msg, tipo = 'success') {
      const c = document.getElementById('toast-container');
      const el = document.createElement('div');
      el.className = `toast ${tipo}`;
      el.textContent = msg;
      c.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    // ‚îÄ‚îÄ‚îÄ API HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function api(path, opts = {}) {
      const r = await fetch(API + path, {
        headers: { 'Content-Type': 'application/json' },
        ...opts
      });
      if (!r.ok) { const e = await r.json().catch(() => ({ detail: 'Erro' })); throw new Error(e.detail || 'Erro'); }
      return r.json();
    }

    // ‚îÄ‚îÄ‚îÄ MODAIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function abrirModal(id) { document.getElementById(id).classList.add('open'); }
    function fecharModal(id) { if (id) { document.getElementById(id).classList.remove('open'); } else { document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open')); } }

    // ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function carregarDashboard() {
      try {
        const d = await api('/dashboard');
        document.getElementById('stat-contatos').textContent = d.total_contatos;
        document.getElementById('stat-agendamentos').textContent = d.total_agendamentos;
        document.getElementById('stat-usuarios').textContent = d.total_usuarios;
        document.getElementById('stat-instancias').textContent = d.total_instancias;
        const tbody = document.getElementById('tbody-recentes');
        if (d.recentes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty"><p>Nenhuma atividade</p></td></tr>';
        } else {
          tbody.innerHTML = d.recentes.map(r => `
        <tr>
          <td>${r.nome || '‚Äî'}</td>
          <td>${r.telefone}</td>
          <td>${formatDate(r.criado_em)}</td>
        </tr>`).join('');
        }
      } catch (e) { toast('Erro ao carregar dashboard', 'error'); }
    }

    // ‚îÄ‚îÄ‚îÄ CONTATOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function carregarContatos(q = '') {
      try {
        const list = await api('/contatos' + (q ? `?q=${encodeURIComponent(q)}` : ''));
        const tbody = document.getElementById('tbody-contatos');
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty"><p>Nenhum contato cadastrado</p></td></tr>';
          return;
        }
        tbody.innerHTML = list.map(c => `
      <tr>
        <td><strong>${c.nome || '‚Äî'}</strong></td>
        <td>${c.telefone}</td>
        <td>${c.cpf || '‚Äî'}</td>
        <td>${formatDate(c.criado_em)}</td>
        <td>
          <div style="display:flex;gap:6px">
            <button class="btn btn-outline btn-sm" onclick="verContato(${c.id})">Ver</button>
            <button class="btn btn-outline btn-sm" onclick="abrirModalMensagem('${c.telefone}','${(c.nome || c.telefone).replace("'", "")}')" title="Enviar WhatsApp" style="color:#25D366">üí¨</button>
            <button class="btn btn-danger btn-sm" onclick="deletarContato(${c.id})">Excluir</button>
          </div>
        </td>
      </tr>`).join('');
      } catch (e) { toast('Erro ao carregar contatos', 'error'); }
    }

    function buscarContatos() {
      const q = document.getElementById('search-contatos').value;
      carregarContatos(q);
    }

    function abrirModalContato() {
      document.getElementById('contato-nome').value = '';
      document.getElementById('contato-telefone').value = '';
      document.getElementById('contato-cpf').value = '';
      document.getElementById('contato-email').value = '';
      document.getElementById('contato-obs').value = '';
      abrirModal('modal-contato');
    }

    async function salvarContato() {
      const telefone = document.getElementById('contato-telefone').value.trim();
      if (!telefone) { toast('Telefone √© obrigat√≥rio', 'error'); return; }
      try {
        await api('/contatos', {
          method: 'POST',
          body: JSON.stringify({
            nome: document.getElementById('contato-nome').value,
            telefone,
            cpf: document.getElementById('contato-cpf').value,
            email: document.getElementById('contato-email').value,
            observacoes: document.getElementById('contato-obs').value,
          })
        });
        fecharModal('modal-contato');
        toast('Contato salvo!');
        carregarContatos();
      } catch (e) { toast(e.message, 'error'); }
    }

    async function deletarContato(id) {
      if (!confirm('Excluir este contato?')) return;
      try {
        await api(`/contatos/${id}`, { method: 'DELETE' });
        toast('Contato exclu√≠do!');
        carregarContatos();
      } catch (e) { toast('Erro ao excluir', 'error'); }
    }

    async function verContato(id) {
      try {
        const c = await api(`/contatos/${id}`);
        const div = document.getElementById('detalhe-content');
        const tipoLabel = { 'primeira_consulta': '1¬™ Consulta', 'retorno': 'Retorno', 'urgente': 'Urgente' };
        const statusBadge = { 'agendado': 'badge-gold', 'realizado': 'badge-green', 'cancelado': 'badge-red' };

        div.innerHTML = `
      <div class="detail-grid" style="margin-bottom:24px">
        <div class="detail-card">
          <h4>Dados do Contato</h4>
          <div class="detail-field"><label>Nome</label><span>${c.nome || '‚Äî'}</span></div>
          <div class="detail-field"><label>Telefone</label><span>${c.telefone}</span></div>
          <div class="detail-field"><label>CPF</label><span>${c.cpf || '‚Äî'}</span></div>
          <div class="detail-field"><label>Email</label><span>${c.email || '‚Äî'}</span></div>
          <div class="detail-field"><label>Observa√ß√µes</label><span>${c.observacoes || '‚Äî'}</span></div>
        </div>
        <div class="detail-card">
          <h4>Agendamentos</h4>
          ${c.agendamentos.length === 0 ? '<p style="color:var(--text-muted);font-size:13px">Nenhum agendamento</p>' :
            c.agendamentos.map(a => `
              <div style="padding:10px 0;border-bottom:1px solid var(--border)">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <span style="font-size:13px">${formatDateBR(a.data_consulta)} √†s ${a.hora_consulta}</span>
                  <span class="badge ${statusBadge[a.status] || 'badge-gray'}">${a.status}</span>
                </div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${tipoLabel[a.tipo_consulta] || a.tipo_consulta}</div>
              </div>`).join('')
          }
        </div>
      </div>

      <div class="detail-card" style="margin-bottom:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h4 style="margin:0">Documentos</h4>
          <label class="btn btn-outline btn-sm" style="cursor:pointer">
            + Enviar arquivo
            <input type="file" style="display:none" onchange="uploadDocumento(${id}, this)">
          </label>
        </div>
        <div id="lista-docs-${id}">
          ${c.documentos.length === 0 ? '<p style="color:var(--text-muted);font-size:13px">Nenhum documento</p>' :
            c.documentos.map(d => `
              <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
                <div>
                  <span style="font-size:13px">üìÑ ${d.nome}</span>
                  <span style="font-size:11px;color:var(--text-muted);margin-left:8px">${formatDate(d.criado_em)}</span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="deletarDoc(${d.id},${id})">Excluir</button>
              </div>`).join('')
          }
        </div>
      </div>`;

        showPage('contato-detalhe');
      } catch (e) { toast('Erro ao carregar contato', 'error'); }
    }

    async function uploadDocumento(contatoId, input) {
      const file = input.files[0];
      if (!file) return;
      const form = new FormData();
      form.append('file', file);
      try {
        const r = await fetch(`${API}/contatos/${contatoId}/documentos`, { method: 'POST', body: form });
        if (!r.ok) throw new Error();
        toast('Documento enviado!');
        verContato(contatoId);
      } catch (e) { toast('Erro ao enviar documento', 'error'); }
    }

    async function deletarDoc(docId, contatoId) {
      if (!confirm('Excluir este documento?')) return;
      try {
        await api(`/documentos/${docId}`, { method: 'DELETE' });
        toast('Documento exclu√≠do!');
        verContato(contatoId);
      } catch (e) { toast('Erro', 'error'); }
    }

    // ‚îÄ‚îÄ‚îÄ AGENDAMENTOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function carregarAgendamentos() {
      try {
        const list = await api('/agendamentos');
        const tbody = document.getElementById('tbody-agendamentos');
        const tipoLabel = { 'primeira_consulta': '1¬™ Consulta', 'retorno': 'Retorno', 'urgente': 'Urgente' };
        const statusBadge = { 'agendado': 'badge-gold', 'realizado': 'badge-green', 'cancelado': 'badge-red' };
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty"><p>Nenhum agendamento</p></td></tr>';
          return;
        }
        tbody.innerHTML = list.map(a => `
      <tr style="cursor:pointer" onclick="abrirDetalheAgendamento(${a.id}, event)">
        <td><strong>${a.contato_nome || '‚Äî'}</strong></td>
        <td>${a.contato_telefone || '‚Äî'}</td>
        <td>${formatDateBR(a.data_consulta) || '‚Äî'}</td>
        <td>${a.hora_consulta || '‚Äî'}</td>
        <td><span class="badge badge-blue">${tipoLabel[a.tipo_consulta] || a.tipo_consulta || '‚Äî'}</span></td>
        <td><span class="badge ${statusBadge[a.status] || 'badge-gray'}">${a.status || '‚Äî'}</span></td>
        <td onclick="event.stopPropagation()">
          <div style="display:flex;gap:6px">
            <button class="btn btn-outline btn-sm" onclick="marcarRealizado(${a.id})">‚úì</button>
            <button class="btn btn-danger btn-sm" onclick="deletarAgendamento(${a.id})">‚úï</button>
          </div>
        </td>
      </tr>`).join('');
      } catch (e) { toast('Erro ao carregar agendamentos', 'error'); }
    }

    // ‚îÄ‚îÄ‚îÄ CALEND√ÅRIO DE AGENDAMENTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _semanaOffset = 0;
    let _ocupadosCache = {};
    let _dataSelecionada = null;

    async function abrirModalAgendamento() {
      _semanaOffset = 0;
      _dataSelecionada = null;
      _ocupadosCache = {};

      // Carregar contatos
      const contatos = await api('/contatos');
      const sel = document.getElementById('ag-contato');
      sel.innerHTML = '<option value="">Selecione um contato...</option>' +
        contatos.map(c => `<option value="${c.id}">${c.nome || c.telefone}</option>`).join('');
      sel.value = '';

      // Limpar campos
      document.getElementById('ag-data').value = '';
      document.getElementById('ag-hora').value = '';
      document.getElementById('ag-tipo').value = 'primeira_consulta';
      document.getElementById('ag-horarios-group').style.display = 'none';
      const obs = document.getElementById('ag-obs');
      if (obs) obs.value = '';

      abrirModal('modal-agendamento');
      await renderizarCalendario();
    }

    async function renderizarCalendario() {
      const titulo = document.getElementById('cal-titulo');
      const grid = document.getElementById('cal-dias');
      titulo.textContent = 'Carregando...';
      grid.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">‚è≥ Buscando disponibilidade...</div>';

      // Calcular dias da semana
      const hoje = new Date();
      const inicioSemana = new Date(hoje);
      inicioSemana.setDate(hoje.getDate() - hoje.getDay() + 1 + (_semanaOffset * 7));

      const dias = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date(inicioSemana);
        d.setDate(inicioSemana.getDate() + i);
        dias.push(d);
      }

      // T√≠tulo da semana
      const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      const ini = dias[0]; const fim = dias[4];
      titulo.textContent = `${ini.getDate()} ${meses[ini.getMonth()]} ‚Äî ${fim.getDate()} ${meses[fim.getMonth()]} ${fim.getFullYear()}`;

      // Buscar ocupados para cada dia em paralelo
      const ocupadosPorDia = {};
      await Promise.all(dias.map(async d => {
        const key = d.toISOString().split('T')[0];
        if (_ocupadosCache[key] !== undefined) {
          ocupadosPorDia[key] = _ocupadosCache[key];
          return;
        }
        try {
          const res = await fetch(`/api/horarios-ocupados/${key}`);
          const ocupados = await res.json();
          _ocupadosCache[key] = ocupados;
          ocupadosPorDia[key] = ocupados;
        } catch (e) {
          ocupadosPorDia[key] = [];
        }
      }));

      const TOTAL_HORARIOS = 8; // 08,09,10,11,13,14,15,16
      const diaSemNomes = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex'];

      grid.innerHTML = '';
      // Header dos dias
      diaSemNomes.forEach(n => {
        const h = document.createElement('div');
        h.style.cssText = 'text-align:center;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;padding-bottom:4px';
        h.textContent = n;
        grid.appendChild(h);
      });

      // C√©lulas dos dias
      const hojeStr = new Date().toISOString().split('T')[0];
      dias.forEach((d, i) => {
        const key = d.toISOString().split('T')[0];
        const isPast = key < hojeStr;
        const ocupados = ocupadosPorDia[key] || [];
        const livres = TOTAL_HORARIOS - ocupados.length;
        const isSelecionado = key === _dataSelecionada;

        const cel = document.createElement('div');
        cel.style.cssText = `
      text-align:center;padding:10px 4px;border-radius:8px;cursor:${isPast ? 'not-allowed' : 'pointer'};
      border:2px solid ${isSelecionado ? 'var(--gold)' : 'transparent'};
      background:${isPast ? 'transparent' : isSelecionado ? 'rgba(212,175,55,0.1)' : 'var(--surface)'};
      opacity:${isPast ? '0.4' : '1'};
      transition:all 0.15s;
    `;

        const corLivres = livres === 0 ? '#e05c5c' : livres <= 2 ? '#e0a85c' : '#5cb85c';

        cel.innerHTML = `
      <div style="font-size:18px;font-weight:700;color:var(--text)">${d.getDate()}</div>
      <div style="font-size:10px;margin-top:4px;color:${isPast || livres === 0 ? 'var(--text-muted)' : corLivres};font-weight:600">
        ${isPast ? '‚Äî' : livres === 0 ? 'Lotado' : livres + ' vagas'}
      </div>
    `;

        if (!isPast && livres > 0) {
          cel.onmouseenter = () => { if (key !== _dataSelecionada) cel.style.background = 'var(--hover)'; };
          cel.onmouseleave = () => { if (key !== _dataSelecionada) cel.style.background = 'var(--surface)'; };
          cel.onclick = () => selecionarData(key, d, ocupados);
        }

        grid.appendChild(cel);
      });
    }

    async function selecionarData(dataStr, dateObj, ocupados) {
      _dataSelecionada = dataStr;
      document.getElementById('ag-data').value = dataStr;
      document.getElementById('ag-hora').value = '';

      // Re-renderizar para mostrar sele√ß√£o
      await renderizarCalendario();

      // Mostrar hor√°rios dispon√≠veis
      const TODOS = ['08:00', '09:00', '10:00', '11:00', '13:00', '14:00', '15:00', '16:00'];
      const livres = TODOS.filter(h => !ocupados.includes(h));

      const group = document.getElementById('ag-horarios-group');
      const horGrid = document.getElementById('ag-horarios-grid');
      group.style.display = 'block';

      if (livres.length === 0) {
        horGrid.innerHTML = '<span style="color:#e05c5c;font-size:13px">Nenhum hor√°rio dispon√≠vel neste dia</span>';
        return;
      }

      horGrid.innerHTML = livres.map(h => `
    <button type="button" id="hor-${h.replace(':', '-')}" onclick="selecionarHora('${h}')"
      style="padding:8px 14px;border:2px solid var(--border);border-radius:8px;background:var(--surface);
             color:var(--text);cursor:pointer;font-size:13px;font-weight:600;transition:all 0.15s"
      onmouseover="this.style.borderColor='var(--gold)'"
      onmouseout="if(document.getElementById('ag-hora').value!=='${h}') this.style.borderColor='var(--border)'">
      ‚è∞ ${h}
    </button>
  `).join('');
    }

    function selecionarHora(hora) {
      document.getElementById('ag-hora').value = hora;
      // Destacar bot√£o selecionado
      document.querySelectorAll('#ag-horarios-grid button').forEach(b => {
        b.style.borderColor = 'var(--border)';
        b.style.background = 'var(--surface)';
        b.style.color = 'var(--text)';
      });
      const btn = document.getElementById('hor-' + hora.replace(':', '-'));
      if (btn) {
        btn.style.borderColor = 'var(--gold)';
        btn.style.background = 'rgba(212,175,55,0.15)';
        btn.style.color = 'var(--gold)';
      }
    }

    async function mudarSemana(offset) {
      _semanaOffset += offset;
      if (_semanaOffset < 0) _semanaOffset = 0;
      await renderizarCalendario();
    }

    async function salvarAgendamento() {
      const clienteId = document.getElementById('ag-contato').value;
      const data = document.getElementById('ag-data').value;
      const hora = document.getElementById('ag-hora').value;

      if (!clienteId) { toast('Selecione um contato', 'error'); return; }
      if (!data) { toast('Selecione uma data no calend√°rio', 'error'); return; }
      if (!hora) { toast('Selecione um hor√°rio', 'error'); return; }

      try {
        await api('/agendamentos', {
          method: 'POST',
          body: JSON.stringify({
            cliente_id: parseInt(clienteId),
            data: data,
            hora: hora,
            tipo: document.getElementById('ag-tipo').value,
            observacoes: document.getElementById('ag-obs').value || '',
          })
        });
        fecharModal('modal-agendamento');
        toast('‚úÖ Agendamento criado com sucesso!');
        carregarAgendamentos();
        // Limpar cache para atualizar disponibilidade
        _ocupadosCache = {};
      } catch (e) { toast(e.message || 'Erro ao criar agendamento', 'error'); }
    }

    async function marcarRealizado(id) {
      try {
        await api(`/agendamentos/${id}/status?status=realizado`, { method: 'PUT' });
        toast('Marcado como realizado!');
        carregarAgendamentos();
      } catch (e) { toast('Erro', 'error'); }
    }

    async function deletarAgendamento(id) {
      if (!confirm('Cancelar agendamento?')) return;
      try {
        await api(`/agendamentos/${id}`, { method: 'DELETE' });
        toast('Agendamento removido!');
        carregarAgendamentos();
      } catch (e) { toast('Erro', 'error'); }
    }

    // ‚îÄ‚îÄ‚îÄ USU√ÅRIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function carregarUsuarios() {
      try {
        const list = await api('/usuarios');
        const tbody = document.getElementById('tbody-usuarios');
        const perfilBadge = { 'advogado': 'badge-gold', 'atendente': 'badge-blue', 'admin': 'badge-red' };
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty"><p>Nenhum usu√°rio cadastrado</p></td></tr>';
          return;
        }
        tbody.innerHTML = list.map(u => `
      <tr>
        <td><strong>${u.nome}</strong></td>
        <td>${u.email}</td>
        <td><span class="badge ${perfilBadge[u.perfil] || 'badge-gray'}">${u.perfil}</span></td>
        <td>${u.telefone || '‚Äî'}</td>
        <td><span class="badge ${u.ativo ? 'badge-green' : 'badge-red'}">${u.ativo ? 'Ativo' : 'Inativo'}</span></td>
        <td>
          <button class="btn btn-danger btn-sm" onclick="deletarUsuario(${u.id})">Excluir</button>
        </td>
      </tr>`).join('');
      } catch (e) { toast('Erro ao carregar usu√°rios', 'error'); }
    }

    function abrirModalUsuario() {
      ['usuario-nome', 'usuario-email', 'usuario-senha', 'usuario-telefone'].forEach(id => {
        document.getElementById(id).value = '';
      });
      abrirModal('modal-usuario');
    }

    async function salvarUsuario() {
      try {
        await api('/usuarios', {
          method: 'POST',
          body: JSON.stringify({
            nome: document.getElementById('usuario-nome').value,
            email: document.getElementById('usuario-email').value,
            senha: document.getElementById('usuario-senha').value,
            perfil: document.getElementById('usuario-perfil').value,
            telefone: document.getElementById('usuario-telefone').value,
          })
        });
        fecharModal('modal-usuario');
        toast('Usu√°rio criado!');
        carregarUsuarios();
      } catch (e) { toast(e.message, 'error'); }
    }

    async function deletarUsuario(id) {
      if (!confirm('Excluir este usu√°rio?')) return;
      try {
        await api(`/usuarios/${id}`, { method: 'DELETE' });
        toast('Usu√°rio exclu√≠do!');
        carregarUsuarios();
      } catch (e) { toast('Erro', 'error'); }
    }

    // ‚îÄ‚îÄ‚îÄ INST√ÇNCIAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function carregarInstancias() {
      try {
        const list = await api('/instancias');
        const tbody = document.getElementById('tbody-instancias');
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty"><p>Nenhuma inst√¢ncia configurada</p></td></tr>';
          return;
        }
        tbody.innerHTML = list.map(i => `
      <tr>
        <td><strong>${i.nome}</strong></td>
        <td style="font-size:12px;color:var(--text-muted)">${i.evolution_url}</td>
        <td>${i.instance_name}</td>
        <td id="status-${i.id}"><span class="badge badge-gray">verificando...</span></td>
        <td>
          <div style="display:flex;gap:6px">
            <button class="btn btn-outline btn-sm" onclick="verificarStatus(${i.id})">Verificar</button>
            <button class="btn btn-danger btn-sm" onclick="deletarInstancia(${i.id})">Excluir</button>
          </div>
        </td>
      </tr>`).join('');
        list.forEach(i => verificarStatus(i.id));
      } catch (e) { toast('Erro ao carregar inst√¢ncias', 'error'); }
    }

    function alternarCamposIA() {
      const provedor = document.getElementById('inst-ia-provedor').value;
      const campoModelo = document.getElementById('campo-ia-modelo');
      const campoKey = document.getElementById('campo-ia-key');
      const selectModelo = document.getElementById('inst-ia-modelo');

      const modelos = {
        gemini: [
          { value: 'gemini-2.5-flash', label: 'Gemini 2.5 Flash (recomendado)' },
          { value: 'gemini-2.5-pro', label: 'Gemini 2.5 Pro' },
          { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' },
          { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
        ],
        openai: [
          { value: 'gpt-4o-mini', label: 'GPT-4o Mini (recomendado)' },
          { value: 'gpt-4o', label: 'GPT-4o' },
          { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
          { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' },
        ],
        anthropic: [
          { value: 'claude-haiku-4-5-20251001', label: 'Claude Haiku (recomendado)' },
          { value: 'claude-sonnet-4-6', label: 'Claude Sonnet' },
          { value: 'claude-opus-4-6', label: 'Claude Opus' },
        ],
        deepseek: [
          { value: 'deepseek-chat', label: 'DeepSeek Chat (recomendado)' },
          { value: 'deepseek-reasoner', label: 'DeepSeek Reasoner' },
        ],
      };

      if (provedor && modelos[provedor]) {
        selectModelo.innerHTML = modelos[provedor]
          .map(m => `<option value="${m.value}">${m.label}</option>`)
          .join('');
        campoModelo.style.display = 'block';
        campoKey.style.display = 'block';
      } else {
        campoModelo.style.display = 'none';
        campoKey.style.display = 'none';
      }
    }

    function abrirModalInstancia() {
      ['inst-nome', 'inst-url', 'inst-key', 'inst-instance', 'inst-ia-key'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('inst-ia-provedor').value = '';
      document.getElementById('campo-ia-modelo').style.display = 'none';
      document.getElementById('campo-ia-key').style.display = 'none';
      abrirModal('modal-instancia');
    }

    async function salvarInstancia() {
      try {
        await api('/instancias', {
          method: 'POST',
          body: JSON.stringify({
            nome: document.getElementById('inst-nome').value,
            evolution_url: document.getElementById('inst-url').value,
            evolution_key: document.getElementById('inst-key').value,
            instance_name: document.getElementById('inst-instance').value,
          })
        });
        fecharModal('modal-instancia');
        toast('Inst√¢ncia conectada!');
        carregarInstancias();
      } catch (e) { toast(e.message, 'error'); }
    }

    async function verificarStatus(id) {
      try {
        const r = await api(`/instancias/${id}/status`);
        const el = document.getElementById(`status-${id}`);
        if (!el) return;
        const connected = r.status === 'open';
        el.innerHTML = `<span class="dot ${connected ? 'dot-green' : 'dot-red'}"></span><span class="badge ${connected ? 'badge-green' : 'badge-red'}">${connected ? 'Conectado' : r.status}</span>`;
      } catch (e) { }
    }

    async function deletarInstancia(id) {
      if (!confirm('Excluir esta inst√¢ncia?')) return;
      try {
        await api(`/instancias/${id}`, { method: 'DELETE' });
        toast('Inst√¢ncia removida!');
        carregarInstancias();
      } catch (e) { toast('Erro', 'error'); }
    }

    // ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function formatDate(iso) {
      if (!iso) return '‚Äî';
      const d = new Date(iso);
      return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }
    function formatDateBR(str) {
      if (!str) return '‚Äî';
      if (str.includes('-')) {
        const [y, m, d] = str.split('-');
        return `${d}/${m}/${y}`;
      }
      return str;
    }

    // ‚îÄ‚îÄ‚îÄ TEMA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function alternarTema() {
      const isLight = document.body.classList.toggle('light');
      document.getElementById('theme-icon').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('crm-tema', isLight ? 'light' : 'dark');
    }

    function aplicarTema() {
      const saved = localStorage.getItem('crm-tema');
      if (saved === 'light') {
        document.body.classList.add('light');
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
      }
    }

    // Fechar modal ao clicar fora
    document.querySelectorAll('.modal-overlay').forEach(el => {
      el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
    });

    // Init
    aplicarTema();
    carregarDashboard();

    async function abrirDetalheAgendamento(id, event) {
      try {
        const list = await api('/agendamentos');
        const a = list.find(x => x.id === id);
        if (!a) return;

        let contato = null;
        if (a.cliente_id) {
          try { contato = await api('/contatos/' + a.cliente_id); } catch (e) { }
        }

        const tipoLabel = { 'primeira_consulta': '1¬™ Consulta', 'retorno': 'Retorno', 'urgente': 'Urgente' };
        const statusBadge = { 'agendado': 'badge-gold', 'realizado': 'badge-green', 'cancelado': 'badge-red', 'ativo': 'badge-gold' };

        document.getElementById('modal-title').textContent = 'Agendamento #' + a.id;
        document.getElementById('modal-body').innerHTML = `
      <div class="detail-grid">
        <div class="detail-card">
          <h4>Dados do Agendamento</h4>
          <div class="detail-field"><label>Cliente</label><span>${a.contato_nome || '‚Äî'}</span></div>
          <div class="detail-field"><label>Telefone</label><span>${a.contato_telefone || '‚Äî'}</span></div>
          <div class="detail-field"><label>Data</label><span>${formatDateBR(a.data_consulta) || '‚Äî'}</span></div>
          <div class="detail-field"><label>Hora</label><span>${a.hora_consulta || '‚Äî'}</span></div>
          <div class="detail-field"><label>Tipo</label><span>${tipoLabel[a.tipo_consulta] || a.tipo_consulta || '‚Äî'}</span></div>
          <div class="detail-field"><label>Status</label><span class="badge ${statusBadge[a.status] || 'badge-gray'}">${a.status || '‚Äî'}</span></div>
          ${a.observacoes ? `<div class="detail-field"><label>Observa√ß√µes</label><span>${a.observacoes}</span></div>` : ''}
        </div>
        ${contato ? `
        <div class="detail-card">
          <h4>Dados do Cliente</h4>
          <div class="detail-field"><label>Nome</label><span>${contato.nome || '‚Äî'}</span></div>
          <div class="detail-field"><label>CPF</label><span>${contato.cpf || '‚Äî'}</span></div>
          <div class="detail-field"><label>Email</label><span>${contato.email || '‚Äî'}</span></div>
          <div class="detail-field"><label>Observa√ß√µes</label><span style="white-space:pre-wrap;font-size:12px">${contato.observacoes || '‚Äî'}</span></div>
        </div>` : ''}
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-outline" onclick="marcarRealizado(${a.id});fecharModal()">‚úì Marcar Realizado</button>
        <button class="btn btn-danger" onclick="deletarAgendamento(${a.id});fecharModal()">‚úï Cancelar</button>
        ${contato ? `<button class="btn btn-outline" onclick="fecharModal();abrirContato(${contato.id})">Ver Contato Completo</button>` : ''}
      </div>
    `;
        abrirModal('modal-generico');
      } catch (e) { console.error(e); toast('Erro ao abrir agendamento', 'error'); }
    }


    // ‚îÄ‚îÄ‚îÄ MENSAGEM WHATSAPP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function abrirModalMensagem(telefone, nome) {
      document.getElementById('msg-destinatario').value = nome;
      document.getElementById('msg-telefone').value = telefone;
      document.getElementById('msg-destinatario-label').textContent = nome || telefone;
      document.getElementById('msg-telefone-label').textContent = telefone;
      document.getElementById('msg-avatar').textContent = (nome || telefone || '?')[0].toUpperCase();
      document.getElementById('msg-texto').value = '';
      document.getElementById('msg-char-count').textContent = '0';
      abrirModal('modal-mensagem');
      setTimeout(() => document.getElementById('msg-texto').focus(), 100);
    }

    async function enviarMensagemWhatsApp() {
      const telefone = document.getElementById('msg-telefone').value;
      const mensagem = document.getElementById('msg-texto').value.trim();
      document.getElementById('msg-char-count').textContent = mensagem.length;
      if (!mensagem) { toast('Digite uma mensagem', 'error'); return; }

      const btn = document.getElementById('btn-enviar-msg');
      if (btn) { btn.disabled = true; btn.innerHTML = '‚è≥ Enviando...'; }

      try {
        await api('/enviar-mensagem', {
          method: 'POST',
          body: JSON.stringify({ telefone, mensagem })
        });
        toast('Mensagem enviada com sucesso! ‚úÖ', 'success');
        fecharModal('modal-mensagem');
      } catch (e) {
        toast('Erro ao enviar: ' + (e.message || 'verifique a inst√¢ncia WhatsApp'), 'error');
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<span>üì§</span> Enviar Mensagem'; }
      }
    }


    document.addEventListener('DOMContentLoaded', () => {
      const textarea = document.getElementById('msg-texto');
      if (textarea) {
        textarea.addEventListener('input', () => {
          const el = document.getElementById('msg-char-count');
          if (el) el.textContent = textarea.value.length;
        });
      }
    });

  </script>

  <!-- Modal Gen√©rico para detalhes -->
  <div class="modal-overlay" id="modal-generico" onclick="fecharModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:700px;width:95%">
      <div class="modal-header">
        <h3 id="modal-title">Detalhes</h3>
        <button class="btn-close" onclick="fecharModal()">‚úï</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>


  <!-- Modal Enviar Mensagem WhatsApp -->
  <div class="modal-overlay" id="modal-mensagem" onclick="fecharModal('modal-mensagem')">
    <div class="modal" onclick="event.stopPropagation()"
      style="max-width:460px;width:95%;border-radius:16px;overflow:hidden">
      <div class="modal-header"
        style="background:linear-gradient(135deg,#25D366,#128C7E);padding:20px 24px;border:none">
        <div style="display:flex;align-items:center;gap:10px">
          <div
            style="width:36px;height:36px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px">
            üí¨</div>
          <div>
            <h3 style="color:#fff;margin:0;font-size:16px">Enviar Mensagem</h3>
            <span style="color:rgba(255,255,255,0.75);font-size:12px">via WhatsApp</span>
          </div>
        </div>
        <button class="btn-close" onclick="fecharModal('modal-mensagem')" style="color:#fff;opacity:0.8">‚úï</button>
      </div>
      <div class="modal-body" style="padding:24px">

        <!-- Destinat√°rio -->
        <div
          style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:16px">
          <div
            style="width:40px;height:40px;background:linear-gradient(135deg,#25D366,#128C7E);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px;flex-shrink:0"
            id="msg-avatar">J</div>
          <div style="flex:1;min-width:0">
            <div style="font-weight:600;color:var(--text);font-size:14px" id="msg-destinatario-label">‚Äî</div>
            <div style="color:var(--text-muted);font-size:12px;display:flex;align-items:center;gap:4px">
              <span>üì±</span>
              <span id="msg-telefone-label">‚Äî</span>
            </div>
          </div>
          <div style="width:8px;height:8px;background:#25D366;border-radius:50%" title="Online"></div>
        </div>

        <!-- Inputs hidden -->
        <input type="hidden" id="msg-destinatario">
        <input type="hidden" id="msg-telefone">

        <!-- Mensagem -->
        <div style="margin-bottom:16px">
          <label
            style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Mensagem</label>
          <textarea id="msg-texto" rows="5" placeholder="Digite sua mensagem aqui..."
            style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text);resize:vertical;font-family:inherit;font-size:14px;line-height:1.5;transition:border-color 0.2s;box-sizing:border-box;outline:none"
            onfocus="this.style.borderColor='#25D366'" onblur="this.style.borderColor='var(--border)'"></textarea>
          <div style="text-align:right;font-size:11px;color:var(--text-muted);margin-top:4px">
            <span id="msg-char-count">0</span> caracteres
          </div>
        </div>

        <!-- Bot√µes -->
        <div style="display:flex;gap:8px">
          <button class="btn btn-outline" onclick="fecharModal('modal-mensagem')" style="flex:1">Cancelar</button>
          <button onclick="enviarMensagemWhatsApp()" id="btn-enviar-msg"
            style="flex:2;padding:10px 16px;background:#25D366;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background 0.2s"
            onmouseover="this.style.background='#128C7E'" onmouseout="this.style.background='#25D366'">
            <span>üì§</span> Enviar Mensagem
          </button>
        </div>
      </div>
    </div>
  </div>

</body>

</html>